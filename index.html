<!doctype html><html lang="fr"><head><meta charset="utf-8"><title>Survival</title><style type="text/css">*{margin:0;padding:0}*,::after,::before{-webkit-box-sizing:border-box;box-sizing:border-box}body,html{height:100%}body{background:#000}#wrapper{position:absolute;top:calc(50% - 500px);left:calc(50% - 700px);width:1400px;height:1000px}#game{width:1000px;height:1000px;background:#000;-webkit-animation:shake 20s;animation:shake 20s;-webkit-animation-iteration-count:infinite;animation-iteration-count:infinite}#game.moving{-webkit-animation-duration:3s;animation-duration:3s}#game.sprinting{-webkit-animation-duration:1s;animation-duration:1s}@-webkit-keyframes shake{0%{-webkit-transform:translate(1px,1px) rotate(0);transform:translate(1px,1px) rotate(0)}10%{-webkit-transform:translate(-1px,0) rotate(-.1deg);transform:translate(-1px,0) rotate(-.1deg)}20%{-webkit-transform:translate(0,0) rotate(.1deg);transform:translate(0,0) rotate(.1deg)}30%{-webkit-transform:translate(0,1px) rotate(0);transform:translate(0,1px) rotate(0)}40%{-webkit-transform:translate(1px,-1px) rotate(.1deg);transform:translate(1px,-1px) rotate(.1deg)}50%{-webkit-transform:translate(-1px,1px) rotate(-.1deg);transform:translate(-1px,1px) rotate(-.1deg)}60%{-webkit-transform:translate(0,1px) rotate(0);transform:translate(0,1px) rotate(0)}70%{-webkit-transform:translate(0,1px) rotate(-.1deg);transform:translate(0,1px) rotate(-.1deg)}80%{-webkit-transform:translate(-1px,-1px) rotate(.1deg);transform:translate(-1px,-1px) rotate(.1deg)}90%{-webkit-transform:translate(1px,-1px) rotate(0);transform:translate(1px,-1px) rotate(0)}100%{-webkit-transform:translate(1px,1px) rotate(-.1deg);transform:translate(1px,1px) rotate(-.1deg)}}@keyframes shake{0%{-webkit-transform:translate(1px,1px) rotate(0);transform:translate(1px,1px) rotate(0)}10%{-webkit-transform:translate(-1px,0) rotate(-.1deg);transform:translate(-1px,0) rotate(-.1deg)}20%{-webkit-transform:translate(0,0) rotate(.1deg);transform:translate(0,0) rotate(.1deg)}30%{-webkit-transform:translate(0,1px) rotate(0);transform:translate(0,1px) rotate(0)}40%{-webkit-transform:translate(1px,-1px) rotate(.1deg);transform:translate(1px,-1px) rotate(.1deg)}50%{-webkit-transform:translate(-1px,1px) rotate(-.1deg);transform:translate(-1px,1px) rotate(-.1deg)}60%{-webkit-transform:translate(0,1px) rotate(0);transform:translate(0,1px) rotate(0)}70%{-webkit-transform:translate(0,1px) rotate(-.1deg);transform:translate(0,1px) rotate(-.1deg)}80%{-webkit-transform:translate(-1px,-1px) rotate(.1deg);transform:translate(-1px,-1px) rotate(.1deg)}90%{-webkit-transform:translate(1px,-1px) rotate(0);transform:translate(1px,-1px) rotate(0)}100%{-webkit-transform:translate(1px,1px) rotate(-.1deg);transform:translate(1px,1px) rotate(-.1deg)}}.phone{display:inline-block;position:absolute;top:0;right:0;-webkit-box-sizing:content-box!important;box-sizing:content-box!important;width:375px;height:667px;padding:105px 24px;border-radius:56px;background:#464646;-webkit-box-shadow:inset 0 0 3px 0 rgba(0,0,0,.7);box-shadow:inset 0 0 3px 0 rgba(0,0,0,.7);-webkit-transform:scale(.7);transform:scale(.7)}.phone .screen{width:100%;position:relative;height:100%;z-index:3;background:#fff;overflow:hidden;display:block;border-radius:1px;background:#222}.phone .bottom-bar,.phone .top-bar{height:3px;background:#000;width:100%;display:block}.phone .middle-bar{width:3px;height:4px;top:0;left:90px;background:#000;position:absolute}.phone:before{width:calc(100% - 12px);height:calc(100% - 12px);position:absolute;top:6px;content:'';left:6px;border-radius:50px;background:#f8f8f8;z-index:1}.phone:after{width:calc(100% - 16px);height:calc(100% - 16px);position:absolute;top:8px;content:'';left:8px;border-radius:48px;-webkit-box-shadow:inset 0 0 3px 0 rgba(0,0,0,.1),inset 0 0 6px 3px #fff;box-shadow:inset 0 0 3px 0 rgba(0,0,0,.1),inset 0 0 6px 3px #fff;z-index:2}.phone .home{border-radius:100%;width:68px;height:68px;position:absolute;left:50%;margin-left:-34px;bottom:22px;z-index:3;background:#080808;background:linear-gradient(135deg,#080808 0,#464646 50%,#080808 100%)}.phone .home:before{background:#080808;position:absolute;content:'';border-radius:100%;width:calc(100% - 8px);height:calc(100% - 8px);top:4px;left:4px}.phone .top-bar{height:14px;background:#212121;position:absolute;top:68px;left:0}.phone .bottom-bar{height:14px;background:#212121;position:absolute;bottom:68px;left:0}.phone .sleep{position:absolute;top:190px;right:-4px;width:4px;height:66px;border-radius:0 2px 2px 0;background:#464646}.phone .volume{position:absolute;left:-4px;top:188px;z-index:0;height:66px;width:4px;border-radius:2px 0 0 2px;background:#464646}.phone .volume:before{position:absolute;left:2px;top:-78px;height:40px;width:2px;border-radius:2px 0 0 2px;background:inherit;content:'';display:block}.phone .volume:after{position:absolute;left:0;top:82px;height:66px;width:4px;border-radius:2px 0 0 2px;background:inherit;content:'';display:block}.phone .camera{background:#080808;width:12px;height:12px;position:absolute;top:24px;left:50%;margin-left:-6px;border-radius:100%;z-index:3}.phone .sensor{background:#3c3d3d;width:16px;height:16px;position:absolute;top:49px;left:134px;z-index:3;border-radius:100%}.phone .speaker{background:#292728;width:70px;height:6px;position:absolute;top:54px;left:50%;margin-left:-35px;border-radius:6px;z-index:3}.phone:before{background:#080808}.phone:after{-webkit-box-shadow:inset 0 0 3px 0 rgba(0,0,0,.1),inset 0 0 6px 3px #212121;box-shadow:inset 0 0 3px 0 rgba(0,0,0,.1),inset 0 0 6px 3px #212121}.phone-app{position:relative;display:inline-block;vertical-align:top;width:33.3333%;padding-top:33.3333%;background:red}.phone-health{background:#ccc}.phone-health-icon{position:absolute;top:45px;left:38px;background-color:#c44;display:inline-block;height:30px;margin:0 10px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);width:30px}.phone-health-icon::after,.phone-health-icon::before{content:"";background-color:#c44;border-radius:50%;height:30px;position:absolute;width:30px}.phone-health-icon::before{top:-15px;left:0}.phone-health-icon::after{left:15px;top:0}.phone-camera{background:#66a}.phone-camera-icon{position:absolute;display:block;top:40px;left:20%;width:60%;height:40%;background-color:#000;border-radius:5px}.phone-camera-icon::after{content:"";display:block;width:35px;height:35px;border:7px solid #66a;position:absolute;top:15%;left:28%;background-color:#000;border-radius:50%}.phone-camera-icon::before{content:"";display:block;width:50%;height:10px;position:absolute;top:-16%;left:25%;background-color:#000;border-radius:10px}.phone-light{background:#ccc}.phone-light-icon{position:absolute;display:block;top:38px;left:55px;width:16px;height:68px;background-image:linear-gradient(to bottom,#000 62px,rgba(0,0,0,0) 62px,rgba(0,0,0,0) 65px,#000 65px,#000 68px)}.phone-light-icon::before{content:'';height:10px;display:block;position:relative;left:-8px;top:-12px;border-top:40px solid #000;border-right:16px solid transparent;border-left:16px solid transparent}.phone-light-icon::after{content:'';display:block}.phone-sound-icon{position:absolute;top:0;left:0;right:0;text-align:center;font-size:80px;line-height:128px}#compass{position:absolute;bottom:87.5px;left:87.5px;width:200px;height:200px;border-radius:50%;margin:0 auto;border:10px solid #333;background:#000;-webkit-box-shadow:0 0 4px #000,0 0 1px 8px #222;box-shadow:0 0 4px #000,0 0 1px 8px #222}#compass::after,#compass::before{content:'';position:absolute;border-radius:50%}#compass::before{border:2px dashed #444;left:10px;right:10px;bottom:10px;top:10px}#compass::after{left:-10px;right:-10px;bottom:-10px;top:-10px;background:linear-gradient(-45deg,rgba(255,255,255,.2) 0,rgba(255,255,255,.05) 47%,rgba(255,255,255,0) 48%,rgba(255,255,255,0) 100%)}#compass span{position:absolute;font-size:14px;font-weight:700;color:#666}#compass span:nth-child(1){top:20px;left:87px}#compass span:nth-child(3){bottom:20px;left:87px}#compass span:nth-child(2){top:87px;right:25px}#compass span:nth-child(4){top:87px;left:25px}@-webkit-keyframes rotate{from{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes rotate{from{-webkit-transform:rotate(0);transform:rotate(0)}to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}#pointer{position:relative;width:60px;height:30px;left:calc(50% - 30px);top:calc(50% - 15px);-webkit-animation:rotate 5s cubic-bezier(1,.2,.5,1) infinite alternate;animation:rotate 5s cubic-bezier(1,.2,.5,1) infinite alternate}#pointer::before{content:'';position:absolute;left:0;right:0;top:0;bottom:0;background:linear-gradient(-63deg,#4fbcf2 1%,#1a6ece 50%,#d8d8d8 51%,#f45e50 53%,#ff2d2d 100%);-webkit-transform:skewX(60deg);transform:skewX(60deg)}#pointer::after{content:'';width:10px;height:10px;background:#4781c0;border-radius:50%;-webkit-box-shadow:inset 0 0 4px 2px #4d4d4d,0 0 5px 1px #fff;box-shadow:inset 0 0 4px 2px #4d4d4d,0 0 5px 1px #fff;position:absolute;left:calc(50% - 5px);top:calc(50% - 5px)}</style></head><body><div id="wrapper"><canvas id="zoom" width="100" height="100"></canvas><canvas id="game" width="1000" height="1000"></canvas><div class="phone"><div class="top-bar"></div><div class="sleep"></div><div class="volume"></div><div class="camera"></div><div class="sensor"></div><div class="speaker"></div><div class="screen"><div class="phone-app phone-camera"><p class="phone-camera-icon"></p><p class="phone-progress-bar"></p></div><div class="phone-app phone-light"><p class="phone-light-icon"></p></div><div class="phone-app phone-sound"><p class="phone-sound-icon">â™«</p></div><div class="phone-app phone-health"><p class="phone-health-icon"></p><p class="phone-progress-bar"></p></div><div id="compass"><span>N</span> <span>E</span> <span>S</span> <span>W</span><div id="pointer"></div></div></div><div class="home"></div><div class="bottom-bar"></div></div></div><script>(function() {
    'use strict';
var gameWrapper = document.getElementById('wrapper');
var gameCanvas = document.getElementById('game');
var gameContext = gameCanvas.getContext('2d');
var xDirection = 0;
var yDirection = 0;
var mapOffsetX = 0;
var mapOffsetY = 0;
var isSprinting = false;
var playerOffsetX = 100;
var playerOffsetY = 180;
var startTime = +new Date();
const MOVE_SPEED = 1;
const SPRINT_SPEED = 2.5;
const FLOOR_COLOR = '#eee';
const WALL_COLOR = '#666';
const PLAYER_BOX_OFFSET = 250;
var canvasCenterX = gameCanvas.width/2;
var canvasCenterY = gameCanvas.height/2;
var lightOffsetX = 0;
var lightOffsetY = 0;
var now = +new Date();
var circleLightRadius = 80; // Radius of light circle, in pixels
var fuzzyRadius = 5;
const CIRCLE_LIGHT_BRIGHTNESS = 0; // Brightness of the scene (opacity of none lightned part)

//LINE SEGMENTS
var segments = [

    // Border
    {a:{x:0,y:0}, b:{x:840,y:0}},
    {a:{x:840,y:0}, b:{x:840,y:840}},
    {a:{x:840,y:840}, b:{x:0,y:840}},
    {a:{x:0,y:840}, b:{x:0,y:0}},

    // Polygon #1
    {a:{x:100,y:150}, b:{x:100,y:50}},
    {a:{x:100,y:50}, b:{x:200,y:50}},
    {a:{x:200,y:50}, b:{x:200,y:210}},
    {a:{x:200,y:210}, b:{x:100,y:210}},
    {a:{x:100,y:210}, b:{x:100,y:200}},
/*
    // Polygon #2
    {a:{x:300,y:100}, b:{x:300,y:250}},
    {a:{x:300,y:300}, b:{x:300,y:420}},
    {a:{x:300,y:420}, b:{x:450,y:420}},
    {a:{x:450,y:420}, b:{x:450,y:100}},
    {a:{x:450,y:100}, b:{x:300,y:100}}*/
];
function checkSize() {
    var ww = window.innerWidth;
    var wh = window.innerHeight;

    var GAME_WIDTH = 1400;
    var GAME_HEIGHT = 1000;

    var scaleX = GAME_WIDTH / ww;
    var scaleY = (GAME_HEIGHT + 20) / wh;
    var gameScale = Math.min(1.2, 1 / Math.max(scaleX, scaleY));

    gameWrapper.style.webkitTransform = gameWrapper.style.transform = 'scale(' + gameScale + ')';
}
/**
 * Adds a light filter over canvas
 */
function generateLightFilter() {
    var canvas = document.createElement('canvas');
    canvas.width = gameCanvas.width;
    canvas.height = gameCanvas.height;
    var context = canvas.getContext('2d');
    
    // Gets light radius. Decrease over time, and has a small variation too to simulate firelight effect
    var lightRadius = circleLightRadius;
    var ligthBritghness = CIRCLE_LIGHT_BRIGHTNESS;

    // Fills a rect with opacity reduced of current brightness
    context.fillStyle = 'rgba(0, 0, 0, ' + (1 - ligthBritghness / 100) + ')';
    context.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

    // Creates a gradient circle
    var x = canvasCenterX + playerOffsetX;// + Player.width / 2;
    var y = canvasCenterY + playerOffsetY
    var blurGradient = context.createRadialGradient(x + lightOffsetX, y + lightOffsetY, 0, x + lightOffsetX, y + lightOffsetY, Math.floor(lightRadius * 1000) / 1000);
    blurGradient.addColorStop(0, 'rgba(0,0,0,1)');
    blurGradient.addColorStop(0.8, 'rgba(0,0,0,.95)');
    blurGradient.addColorStop(1, 'rgba(0,0,0,0)');
    // Draw circle in destination-out to free circle of light
    context.fillStyle = blurGradient;
    context.globalCompositeOperation = 'destination-out';
    context.fillRect(x - lightRadius + lightOffsetX, y - lightRadius + lightOffsetY, lightRadius * 2, lightRadius * 2);

    gameContext.drawImage(canvas, 0, 0);
}
// Find intersection of RAY & SEGMENT
function getIntersection(ray,segment){
    // RAY in parametric: Point + Delta*T1
    var r_px = ray.a.x;
    var r_py = ray.a.y;
    var r_dx = ray.b.x-ray.a.x;
    var r_dy = ray.b.y-ray.a.y;
    // SEGMENT in parametric: Point + Delta*T2
    var s_px = segment.a.x;
    var s_py = segment.a.y;
    var s_dx = segment.b.x-segment.a.x;
    var s_dy = segment.b.y-segment.a.y;

    // Are they parallel? If so, no intersect
    var r_mag = Math.sqrt(r_dx*r_dx+r_dy*r_dy);
    var s_mag = Math.sqrt(s_dx*s_dx+s_dy*s_dy);
    if(r_dx/r_mag==s_dx/s_mag && r_dy/r_mag==s_dy/s_mag){
        // Unit vectors are the same.
        return null;
    }

    // SOLVE FOR T1 & T2
    // r_px+r_dx*T1 = s_px+s_dx*T2 && r_py+r_dy*T1 = s_py+s_dy*T2
    // ==> T1 = (s_px+s_dx*T2-r_px)/r_dx = (s_py+s_dy*T2-r_py)/r_dy
    // ==> s_px*r_dy + s_dx*T2*r_dy - r_px*r_dy = s_py*r_dx + s_dy*T2*r_dx - r_py*r_dx
    // ==> T2 = (r_dx*(s_py-r_py) + r_dy*(r_px-s_px))/(s_dx*r_dy - s_dy*r_dx)
    var T2 = (r_dx*(s_py-r_py) + r_dy*(r_px-s_px))/(s_dx*r_dy - s_dy*r_dx);
    var T1 = (s_px+s_dx*T2-r_px)/r_dx;

    // Must be within parametic whatevers for RAY/SEGMENT
    if(T1<0) return null;
    if(T2<0 || T2>1) return null;

    // Return the POINT OF INTERSECTION
    return {
        x: r_px+r_dx*T1,
        y: r_py+r_dy*T1,
        param: T1
    };
}

function getSightPolygon(sightX,sightY){

    // Get all unique points
    var points = (function(segments){
        var a = [];
        segments.forEach(function(seg){
            a.push(seg.a,seg.b);
        });
        return a;
    })(segments);
    var uniquePoints = (function(points){
        var set = {};
        return points.filter(function(p){
            var key = p.x+","+p.y;
            if(key in set){
                return false;
            }else{
                set[key]=true;
                return true;
            }
        });
    })(points);

    // Get all angles
    var uniqueAngles = [];
    for(var j=0;j<uniquePoints.length;j++){
        var uniquePoint = uniquePoints[j];
        var angle = Math.atan2(uniquePoint.y-sightY,uniquePoint.x-sightX);
        uniquePoint.angle = angle;
        uniqueAngles.push(angle-0.00001,angle,angle+0.00001);
    }

    // RAYS IN ALL DIRECTIONS
    var intersects = [];
    for(var j=0;j<uniqueAngles.length;j++){
        var angle = uniqueAngles[j];

        // Calculate dx & dy from angle
        var dx = Math.cos(angle);
        var dy = Math.sin(angle);

        // Ray from center of screen to player
        var ray = {
            a:{x:sightX,y:sightY},
            b:{x:sightX+dx,y:sightY+dy}
        };

        // Find CLOSEST intersection
        var closestIntersect = null;
        for(var i=0;i<segments.length;i++){
            var intersect = getIntersection(ray,segments[i]);
            if(!intersect) continue;
            if(!closestIntersect || intersect.param<closestIntersect.param){
                closestIntersect=intersect;
            }
        }

        // Intersect angle
        if(!closestIntersect) continue;
        closestIntersect.angle = angle;

        // Add to list of intersects
        intersects.push(closestIntersect);

    }

    // Sort intersects by angle
    intersects = intersects.sort(function(a,b){
        return a.angle-b.angle;
    });

    // Polygon is intersects, in order of angle
    return intersects;
}
function drawWalls() {
    for(var i=0;i<segments.length;++i){
        var segment = segments[i];
        gameContext.strokeStyle = WALL_COLOR;
        gameContext.lineWidth= 8;
        gameContext.beginPath();
        gameContext.moveTo(canvasCenterX + mapOffsetX + segment.a.x, canvasCenterY + mapOffsetY + segment.a.y);
        gameContext.lineTo(canvasCenterX + mapOffsetX + segment.b.x, canvasCenterY + mapOffsetY + segment.b.y);
        gameContext.stroke();
    }
    gameContext.fill();
}

function isColliding() {
    // Gets color data of the zone where the image will be drawn
    var colorData = gameContext.getImageData(canvasCenterX + playerOffsetX - 10, canvasCenterY + playerOffsetY - 10, 20, 20).data;
    // Counts the number of pixels filled with our unique color 
    var wallPixelNumber = 0;
    // TODO: set walls color in hexadecimal, or get dynamic value here if walls are changing color!
    for (var i = 0; i < colorData.length; i += 4) {
      if(colorData[i] === 102 && colorData[i + 1] === 102 && colorData[i + 2] === 102) {
          return true;
      }
    }

    return false;
}

// DRAWING
function draw(){
    // Clear canvas
    gameContext.clearRect(0,0,gameCanvas.width,gameCanvas.height);
    gameContext.fillStyle = '#000';
    gameContext.fillRect(0,0,gameCanvas.width,gameCanvas.height);
    
    // Sets new player position
    var xMovement = xDirection * (isSprinting ? SPRINT_SPEED: MOVE_SPEED);
    var yMovement = yDirection * (isSprinting ? SPRINT_SPEED: MOVE_SPEED);
    var lightMovement =  frameDuration / 30;

    // First draw walls to detect collisions
    drawWalls();
    if(xDirection > 0) {
        if(playerOffsetX < PLAYER_BOX_OFFSET) {
            playerOffsetX += xMovement;
            if(isColliding()) {
                playerOffsetX -= xMovement;
            }
        } else {
            mapOffsetX -= xMovement;
            if(isColliding()) {
                mapOffsetX += xMovement;
            }
        }
        lightOffsetX = Math.min(lightOffsetX + lightMovement, 20);
    }
    else if(xDirection < 0) {
        if(playerOffsetX > -PLAYER_BOX_OFFSET) {
            playerOffsetX += xMovement;
            if(isColliding()) {
                playerOffsetX -= xMovement;
            }
        } else {
            mapOffsetX -= xMovement;
            if(isColliding()) {
                mapOffsetX += xMovement;
            }
        }
        lightOffsetX = Math.max(lightOffsetX - lightMovement, -20);
    } else {
        if(lightOffsetX > 0) {
            lightOffsetX = Math.max(0, lightOffsetX - lightMovement);
        } else {
            lightOffsetX = Math.min(0, lightOffsetX + lightMovement);
        }
    }
    
    if(yDirection > 0) {
        if(playerOffsetY < PLAYER_BOX_OFFSET) {
            playerOffsetY += yMovement;
            if(isColliding()) {
                playerOffsetY -= yMovement;
            }
        } else {
            mapOffsetY -= yMovement;
            if(isColliding()) {
                mapOffsetY += yMovement;
            }
        }
        lightOffsetY = Math.min(lightOffsetY + lightMovement, 20);
    }
    else if(yDirection < 0) {
        if(playerOffsetY > -PLAYER_BOX_OFFSET) {
            playerOffsetY += yMovement;
            if(isColliding()) {
                playerOffsetY -= yMovement;
            }
        } else {
            mapOffsetY -= yMovement;
            if(isColliding()) {
                mapOffsetY += yMovement;
            }
        }
        lightOffsetY = Math.max(lightOffsetY - lightMovement, -20);
    } else {
        if(lightOffsetY > 0) {
            lightOffsetY = Math.max(0, lightOffsetY - lightMovement);
        } else {
            lightOffsetY = Math.min(0, lightOffsetY + lightMovement);
        }
    }

    // Sight Polygons
    var polygons = [getSightPolygon(playerOffsetX - mapOffsetX + lightOffsetX / 4, playerOffsetY - mapOffsetY + lightOffsetY / 4)];

    for(var angle=0;angle<Math.PI*2;angle+=(Math.PI*2)/10){
        var dx = Math.cos(angle)*fuzzyRadius;
        var dy = Math.sin(angle)*fuzzyRadius;
        polygons.push(getSightPolygon(playerOffsetX + mapOffsetX + lightOffsetX / 4 + dx, playerOffsetY - mapOffsetY + lightOffsetY / 4 + dy));
    };

    // DRAW AS A GIANT POLYGON
    for(var i=1;i<polygons.length;i++){
        drawPolygon(polygons[i],gameContext,"rgba(255,255,255,0.08)");
    }
    drawPolygon(polygons[0],gameContext, FLOOR_COLOR);
    drawWalls();

    // Masked Foreground
//    gameContext.globalCompositeOperation = "source-in";
//    gameContext.drawImage(foreground,0,0);
    gameContext.globalCompositeOperation = "source-over";

    
    // Draw dots / Player
    gameContext.fillStyle = '#F00';
    gameContext.beginPath();
    gameContext.arc(canvasCenterX + playerOffsetX, canvasCenterY + playerOffsetY, 10, 0, 2*Math.PI, false);
    gameContext.fill();
    generateLightFilter();
}

function drawPolygon(polygon,gameContext,fillStyle){
    gameContext.fillStyle = fillStyle;
    gameContext.beginPath();
    gameContext.moveTo(canvasCenterX + mapOffsetX + polygon[0].x, canvasCenterY + mapOffsetY +polygon[0].y);
    for(var i=1;i<polygon.length;i++){
        var intersect = polygon[i];
        gameContext.lineTo(canvasCenterX + mapOffsetX + intersect.x, canvasCenterY + mapOffsetY + intersect.y);
    }
    gameContext.fill();
}

var frameDuration = 0;
// DRAW LOOP
window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.msRequestAnimationFrame;
function drawLoop(){
    var previousFrameTime = now;
    now = new Date();
    frameDuration = now - previousFrameTime;
    requestAnimationFrame(drawLoop);
    draw();
}
window.onload = function(){
//    foreground.onload = function(){
//        drawLoop();
//    };
//    foreground.src = "images/floor.jpg";
    drawLoop();
};

document.querySelector('.phone-light').onclick = () => {
    if(circleLightRadius === 150) {
        circleLightRadius = 80;
        fuzzyRadius = 4;
    } else {
        circleLightRadius = 150;
        fuzzyRadius = 10;
    }
};

document.onkeydown = function(e){
    var code = e.keyCode;
    if (code === 39) {
        xDirection = 1;
    } else if (code === 37) {
        xDirection = -1;
    }
    if (code === 38) {
        yDirection = -1;
    } else if (code === 40) {
        yDirection = 1;
    }
    if(xDirection !== 0 || yDirection !== 0) {
        gameCanvas.classList.add(e.shiftKey ? 'sprinting' : 'moving');
        if(e.shiftKey) {
            isSprinting = true;
        }
    }
};

document.onkeyup = function(e){
    var code = e.keyCode;
    if (code === 39) {
        xDirection = 0;
    } else if (code === 37) {
        xDirection = 0;
    }
    if (code === 38) {
        yDirection = 0;
    } else if (code === 40) {
        yDirection = 0;
    }
    if(!e.shiftKey) {
        isSprinting = false;
    }
    gameCanvas.classList.remove('moving', 'sprinting');
};

window.addEventListener('resize', function(k) {
    checkSize();
});
checkSize();
})();</script></body></html>